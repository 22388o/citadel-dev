#!/usr/bin/env bash
set -euo pipefail

show_help() {
  cat << EOF
umbrel-dev 0.0.0

Automatically initialize and manage an Umbrel development environment.

Usage: umbrel-dev <command> [options]

Commands:
    help                    Show this help message
    init                    Initialize an Umbrel development environment in the working directory
    boot                    Boot the development VM
    halt                    Halt the development VM
    destroy                 Destroy the development VM
    rebuild [<container>]   Rebuild all or a specific container
    run <command>           Run a command inside the development VM
    ssh                     Get an SSH session inside the development VM
EOF
}

# Check required dependencies are installed
# If not, fail with instructions on how to fix
check_dependencies() {
  for cmd in "git" "vagrant" "vboxmanage"; do
    if ! command -v $cmd >/dev/null 2>&1; then
      echo "This script requires Git, VirtualBox and Vagrant to be installed."
      echo
      echo "You can install them with brew:"
      echo
      echo "  brew install git"
      echo "  brew cask install vagrant virtualbox"
      exit 1
    fi
  done
}

# Run a command inside the development VM
run() {
  vagrant ssh -c "cd /vagrant/getumbrel/umbrel && $1"
}

# Check deps before running any commands
check_dependencies

if [ -z ${1+x} ]; then
  command=""
else
  command="$1"
fi

# Initialize an Umbrel development environment in the working directory
if [[ "$command" = "init" ]]; then
  mkdir getumbrel
  git clone https://github.com/getumbrel/umbrel.git getumbrel/umbrel
  exit
fi

# Boot the development VM
if [[ "$command" = "boot" ]]; then
  vagrant up
  exit
fi

# Halt the development VM
if [[ "$command" = "halt" ]]; then
  vagrant halt
  exit
fi

# Destroy the development VM
if [[ "$command" = "destroy" ]]; then
  vagrant destroy
  exit
fi

# TODO: Rebuild all or a specific container
if [[ "$command" = "rebuild" ]]; then
  echo "Not yet implemented."
  exit
fi

# Run a command inside the development VM
if [[ "$command" = "run" ]]; then
  run "$2"
  exit
fi

# Get an SSH session inside the development VM
if [[ "$command" = "ssh" ]]; then
  run bash
  exit
fi

# If we get here it means no valid command was supplied
# Show help and exit
show_help
exit 1
